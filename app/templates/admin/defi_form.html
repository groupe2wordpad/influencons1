{% extends 'admin/base.html' %}
{% block page_title %}{% if item %}Modifier le d√©fi{% else %}Nouveau d√©fi{% endif %}{% endblock %}
{% block topbar_actions %}<a href="{{ url_for('admin.defis') }}" class="btn btn-ghost">‚Üê Retour</a>{% endblock %}
{% block content %}
<div class="form-card">
  <form method="POST" enctype="multipart/form-data">

    <div class="form-group">
      <label>Titre du d√©fi *</label>
      <input type="text" name="title" value="{{ item.title if item else '' }}" required placeholder="7 jours pour influencer autrement...">
    </div>

    <div class="form-group">
      <label>Description</label>
      <textarea name="description" rows="4" placeholder="D√©crivez le d√©fi...">{{ item.description if item else '' }}</textarea>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ LIEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="form-group">
      <label>Lien du d√©fi</label>
      <input type="url" name="link"
             value="{{ item.link if item else '' }}"
             placeholder="https://defis.influencons.com">
      <span class="form-hint">URL vers l'application ou la page du d√©fi</span>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ IMAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="form-group">
      <label>Image du d√©fi</label>

      {% if item and item.image_url %}
      <div class="image-preview">
        <img src="{{ item.image_url }}" alt="Image actuelle">
        <span class="image-preview__label">Image actuelle</span>
      </div>
      {% endif %}

      <div class="upload-zone" id="uploadZone">
        <input type="file" name="image_url" id="imageInput" accept="image/*" onchange="previewImage(this)">
        <div class="upload-zone__content" id="uploadContent">
          <span class="upload-zone__icon">üñºÔ∏è</span>
          <span class="upload-zone__text">Cliquez ou glissez une image ici</span>
          <span class="upload-zone__hint">PNG, JPG, WEBP ‚Äî max 5 Mo</span>
        </div>
        <img id="uploadPreview" src="" alt="" style="display:none; width:100%; border-radius:10px; margin-top:8px;">
      </div>

      <p style="font-size:0.75rem; color:var(--text-muted); margin-top:8px; text-align:center;">‚Äî ou ‚Äî</p>

      <input type="url" name="image_url_text"
             value=""
             placeholder="https://... (URL d'une image en ligne)">
      <span class="form-hint">Collez une URL si vous ne souhaitez pas uploader un fichier</span>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ √âTAPES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:16px; text-transform:uppercase; letter-spacing:0.1em;">‚ú¶ Les 3 √©tapes du d√©fi</p>
    <div class="form-grid">
      <div class="form-group">
        <label>√âtape 1 ‚Äî Titre</label>
        <input type="text" name="step1_title" value="{{ item.step1_title if item else '' }}" placeholder="Identifier">
      </div>
      <div class="form-group">
        <label>√âtape 1 ‚Äî Description</label>
        <input type="text" name="step1_desc" value="{{ item.step1_desc if item else '' }}" placeholder="Une personne autour de vous...">
      </div>
      <div class="form-group">
        <label>√âtape 2 ‚Äî Titre</label>
        <input type="text" name="step2_title" value="{{ item.step2_title if item else '' }}" placeholder="Agir">
      </div>
      <div class="form-group">
        <label>√âtape 2 ‚Äî Description</label>
        <input type="text" name="step2_desc" value="{{ item.step2_desc if item else '' }}" placeholder="Un geste concret chaque jour...">
      </div>
      <div class="form-group">
        <label>√âtape 3 ‚Äî Titre</label>
        <input type="text" name="step3_title" value="{{ item.step3_title if item else '' }}" placeholder="T√©moigner">
      </div>
      <div class="form-group">
        <label>√âtape 3 ‚Äî Description</label>
        <input type="text" name="step3_desc" value="{{ item.step3_desc if item else '' }}" placeholder="Partager votre exp√©rience...">
      </div>
    </div>

    <div class="form-group">
      <div class="checkbox-wrap">
        <input type="checkbox" name="is_active" id="active" {% if not item or item.is_active %}checked{% endif %}>
        <label for="active">D√©fi actif (affich√© sur le site)</label>
      </div>
    </div>

    <div style="display:flex; gap:12px;">
      <button type="submit" class="btn btn-gold">{% if item %}üíæ Enregistrer{% else %}‚ú¶ Cr√©er le d√©fi{% endif %}</button>
      <a href="{{ url_for('admin.defis') }}" class="btn btn-ghost">Annuler</a>
    </div>
  </form>
</div>

<!-- ‚îÄ‚îÄ‚îÄ STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<style>
.form-hint {
  display: block; font-size: 0.72rem;
  color: var(--text-muted, #7a6a99);
  margin-top: 4px; letter-spacing: 0.03em;
}

/* Image preview existante */
.image-preview {
  position: relative; margin-bottom: 12px;
  border-radius: 12px; overflow: hidden;
  border: 1px solid rgba(201,168,76,0.2);
  max-height: 220px;
}
.image-preview img {
  width: 100%; max-height: 220px;
  object-fit: cover; display: block;
}
.image-preview__label {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: rgba(30,17,64,0.6);
  color: rgba(255,255,255,0.8);
  font-size: 0.65rem; letter-spacing: 0.15em;
  text-transform: uppercase; text-align: center;
  padding: 6px;
}

/* Upload zone */
.upload-zone {
  border: 2px dashed rgba(201,168,76,0.3);
  border-radius: 12px; padding: 1.5rem;
  text-align: center; cursor: pointer;
  transition: all .3s; background: rgba(201,168,76,0.03);
  position: relative;
}
.upload-zone:hover {
  border-color: rgba(201,168,76,0.6);
  background: rgba(201,168,76,0.06);
}
.upload-zone input[type="file"] {
  position: absolute; inset: 0;
  opacity: 0; cursor: pointer; width: 100%; height: 100%;
}
.upload-zone__content {
  display: flex; flex-direction: column;
  align-items: center; gap: 4px; pointer-events: none;
}
.upload-zone__icon { font-size: 1.8rem; }
.upload-zone__text {
  font-size: 0.85rem; color: var(--text-mid, #3d2d5c); font-weight: 500;
}
.upload-zone__hint {
  font-size: 0.72rem; color: var(--text-muted, #7a6a99);
}
</style>

<script>
function previewImage(input) {
  const preview = document.getElementById('uploadPreview');
  const content = document.getElementById('uploadContent');
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      preview.style.display = 'block';
      content.style.display = 'none';
    };
    reader.readAsDataURL(input.files[0]);
  }
}
</script>

{% endblock %}
